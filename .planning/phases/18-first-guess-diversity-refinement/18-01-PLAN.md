---
phase: 18-first-guess-diversity-refinement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/suggestionEngine.js]
autonomous: true
requirements: []

must_haves:
  truths:
    - "First-guess suggestions show words with diverse letter profiles (not all TARES-like)"
    - "Words with different letter coverage (vowel-heavy, consonant-balanced) appear in top 5 if competitive"
    - "Subsequent guesses (mid_game, late_game) are completely unaffected by diversity logic"
    - "All displayed suggestions are genuinely strong openers — no filler words"
    - "Footer message mentions diversity-aware selection when active on first guess"
    - "Displayed scores (entropy, frequency, confidence) are unchanged"
  artifacts:
    - path: "src/suggestionEngine.js"
      provides: "Diversity-aware near-tie reordering for opener mode"
      contains: "applyDiversityReorder"
  key_links:
    - from: "applyDiversityReorder"
      to: "Fisher-Yates shuffle"
      via: "diversity reorder runs before shuffle in opener near-tie block"
      pattern: "applyDiversityReorder.*clusterIndices"
---

<objective>
Add diversity-aware tie-breaking to the first-guess (opener) suggestion pipeline so that the top 5 suggestions naturally include words with different letter coverage profiles (e.g., vowel-heavy alongside consonant-balanced) instead of 5 words all sharing T, A, R, E, S.

Purpose: Users currently see near-identical openers on every refresh. By demoting words that share 3+ letters with already-ranked-higher words within the near-tie cluster, the top 5 will include a broader variety of strong openers while maintaining mathematical integrity.

Output: Modified `src/suggestionEngine.js` with diversity-aware near-tie reordering and updated footer message.
</objective>

<execution_context>
@C:/Users/avinm/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/avinm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-first-guess-diversity-refinement/18-RESEARCH.md
@src/suggestionEngine.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add diversity-aware near-tie reordering to opener pipeline</name>
  <files>src/suggestionEngine.js</files>
  <action>
Add two helper functions inside the IIFE (before `buildSuggestions`), then integrate them into the opener near-tie block.

**Helper function 1: `getLetterSet(word)`**
Returns an object (used as a set) mapping each unique letter in the word to `true`. Example: `getLetterSet('crane')` returns `{c:true, r:true, a:true, n:true, e:true}`.

**Helper function 2: `applyDiversityReorder(sourceRankings, clusterSize, overlapThreshold)`**
Implements the letter-overlap penalty that reorders the near-tie cluster:

1. Walk through indices 0..clusterSize-1 of `sourceRankings` in rank order.
2. Maintain a `selected` array (indices of words chosen so far) and a `deferred` array (indices of words demoted for overlap).
3. For each candidate at index `i`:
   - Compute its letter set via `getLetterSet`.
   - Compare against each word already in `selected`: count how many letters overlap (intersection of the two letter sets).
   - If overlap >= `overlapThreshold` with ANY selected word, push index to `deferred`.
   - Otherwise, push index to `selected`.
4. Return `selected.concat(deferred)` — an array of reordered indices within the cluster.

**Integration into the opener near-tie block (lines 421-440):**

Inside the `if (clusterSize > MAX_SUGGESTIONS)` block, BEFORE the Fisher-Yates shuffle:

```javascript
// Phase 18: Diversity-aware reordering
var diverseOrder = applyDiversityReorder(sourceRankings, clusterSize, 3);
```

Then modify the Fisher-Yates shuffle to operate on `diverseOrder` instead of sequential `clusterIndices`:

Replace the sequential index initialization:
```javascript
var clusterIndices = new Array(clusterSize);
for (var ci = 0; ci < clusterSize; ci++) {
  clusterIndices[ci] = ci;
}
```
With:
```javascript
var clusterIndices = diverseOrder;
```

This way, selected (diverse) words occupy the front of `clusterIndices`. After Fisher-Yates shuffle and `.slice(0, MAX_SUGGESTIONS)`, diverse words are more likely to survive the sampling. The existing re-sort by index preserves rank order for display.

**overlapThreshold = 3** per user decision. This means words sharing 3 or more unique letters with any already-selected word get deferred to the back of the cluster.

Do NOT:
- Hardcode any specific words (CRANE, SLATE, ADIEU, TARES, etc.)
- Modify entropy, frequency, or blendedScore values
- Change any code outside the `if (mode === 'opener' ...)` block
- Replace the Fisher-Yates shuffle — diversity reordering precedes it
- Touch entropyEngine.js, frequencyScorer.js, or any other file
  </action>
  <verify>
Load the extension on the NYT Wordle page. On a fresh game (empty board), the 5 suggested openers should include words with visibly different letter compositions rather than all sharing the same letters. Refresh multiple times — while the specific words rotate (random sampling), the diversity should be consistent (not 5 words with mostly the same letters).
  </verify>
  <done>
`applyDiversityReorder` function exists and is called inside the opener near-tie block before Fisher-Yates shuffle. `getLetterSet` helper exists. The overlap threshold is 3. Non-opener modes are untouched.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update near-tie footer message for diversity-aware selection</name>
  <files>src/suggestionEngine.js</files>
  <action>
In the near-tie note section (around line 496-501), update the `nearTieNote` string that is shown when `openerClusterSize > MAX_SUGGESTIONS` (i.e., when random sampling was triggered, which is also when diversity reordering is active).

Change from:
```javascript
nearTieNote = 'These openers are statistically very close in expected value \u2014 showing 5 of ' + openerClusterSize + ' near-tied words.';
```

To:
```javascript
nearTieNote = 'These openers are statistically very close in expected value \u2014 showing 5 of ' + openerClusterSize + ' near-tied words, chosen for letter variety.';
```

This adds ", chosen for letter variety." at the end per user decision to "update the existing near-tie footer message to mention diversity-aware selection (keep it concise)."

Do NOT change the non-cluster `detectNearTie` path (the `else` branch) — that handles non-opener states where diversity is not applied.
  </action>
  <verify>
On a fresh game (empty board), the footer below the suggestions should read: "These openers are statistically very close in expected value — showing 5 of N near-tied words, chosen for letter variety." where N is the cluster size.
  </verify>
  <done>
The nearTieNote string includes ", chosen for letter variety." when diversity-aware sampling is active. The non-opener detectNearTie path is unchanged.
  </done>
</task>

</tasks>

<verification>
1. Load extension on NYT Wordle page with an empty board (opener mode)
2. Confirm 5 suggestions appear with diverse letter profiles — not all sharing T/A/R/E/S
3. Confirm footer message reads "...near-tied words, chosen for letter variety."
4. Make a guess (enter mid_game) — confirm suggestions use pure entropy/frequency ranking with no diversity interference
5. Refresh multiple times on empty board — diversity should be consistent while specific words rotate
6. Confirm displayed scores (entropy, frequency, confidence percentages) are unchanged from pre-Phase-18 behavior
</verification>

<success_criteria>
- First-guess suggestions include words with different letter coverage profiles (vowel-heavy, consonant-balanced, etc.)
- All 5 suggestions are genuinely strong openers (within the near-tie cluster)
- Footer message mentions letter variety when diversity sampling is active
- Mid-game and late-game suggestions are completely unaffected
- No hardcoded word lists
</success_criteria>

<output>
After completion, create `.planning/phases/18-first-guess-diversity-refinement/18-01-SUMMARY.md`
</output>
