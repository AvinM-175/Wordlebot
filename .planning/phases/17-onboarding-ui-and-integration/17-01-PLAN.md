---
phase: 17-onboarding-ui-and-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/panelUI.js, src/content.js]
autonomous: true
requirements: [ONBD-03, ONBD-04, ONBD-05, ONBD-06, ONBD-07]

must_haves:
  truths:
    - "First-time user sees onboarding overlay covering the full panel body on page load"
    - "Onboarding shows three numbered tips: what WordleBot does, click to expand cards, Shift+Refresh to reset"
    - "Clicking 'Got it' button dismisses overlay and shows suggestions instantly"
    - "Pressing Escape key dismisses overlay and shows suggestions instantly"
    - "After dismissal, reloading the page never shows onboarding again"
    - "Board state changes while onboarding is visible do not overwrite the overlay"
    - "Onboarding renders inside the existing Shadow DOM panel with no new UI surfaces"
  artifacts:
    - path: "src/panelUI.js"
      provides: "Onboarding CSS classes in existing constructable stylesheet"
      contains: "onboarding-overlay"
    - path: "src/content.js"
      provides: "isOnboardingActive flag, renderOnboarding(), dismissOnboarding(), escapeKeyHandler, processBoardState guard"
      contains: "isOnboardingActive"
  key_links:
    - from: "src/content.js (backgroundInit)"
      to: "window.WordleBot.isFirstInstall"
      via: "strict equality check === true after loadDictionaryAndCaches resolves"
      pattern: "isFirstInstall === true"
    - from: "src/content.js (processBoardState)"
      to: "isOnboardingActive flag"
      via: "guard check before panelRenderer.render() call"
      pattern: "if \\(!isOnboardingActive\\)"
    - from: "src/content.js (dismissOnboarding)"
      to: "chrome.storage.local"
      via: ".set().then() writes wordlebot_onboarded before DOM removal"
      pattern: "chrome\\.storage\\.local\\.set.*wordlebot_onboarded"
    - from: "src/content.js (dismissOnboarding)"
      to: "panelRenderer.render(lastSuggestions)"
      via: "direct render call after overlay removal"
      pattern: "panelRenderer\\.render.*lastSuggestions"
---

<objective>
Add onboarding overlay to the existing Shadow DOM panel for first-time users.

Purpose: First-time users need a brief introduction to WordleBot — what it does, how to interact with suggestions, and how to reset the dictionary. This overlay appears once, is dismissed with "Got it" or Escape, and never returns.

Output: Two modified files (panelUI.js, content.js) implementing the full onboarding lifecycle: CSS styling, overlay rendering, dismiss handling with storage persistence, and processBoardState guard preventing overlay destruction.
</objective>

<execution_context>
@C:/Users/avinm/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/avinm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-first-install-detection-logic/16-01-SUMMARY.md
@src/content.js
@src/panelUI.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add onboarding CSS rules to panelUI.js constructable stylesheet</name>
  <files>src/panelUI.js</files>
  <action>
Append onboarding CSS rules to the existing `createStyles()` function in panelUI.js, inside the `css` string concatenation, BEFORE the `sheet.replaceSync(css)` call. Add after the last existing rule block (`.dict-source` rules).

Add these CSS class rules using the existing `var(--wb-*)` custom properties:

- `.onboarding-overlay` — no special positioning needed (replaces body content entirely); add `padding: 12px 0` for vertical spacing
- `.onboarding-title` — `font-size: 15px`, `font-weight: 600`, `color: var(--wb-text)`, `margin-bottom: 12px`
- `.onboarding-tips` — `list-style: none`, `padding: 0`, `margin: 0 0 16px 0`
- `.onboarding-tip` — `font-size: 13px`, `color: var(--wb-text)`, `line-height: 1.5`, `padding: 8px 0`, `border-bottom: 1px solid var(--wb-border)`
- `.onboarding-tip:last-child` — `border-bottom: none`
- `.onboarding-tip-number` — `font-weight: 600`, `color: var(--wb-text-secondary)`, `margin-right: 4px`
- `.onboarding-dismiss-btn` — `display: block`, `width: 100%`, `padding: 10px 0`, `background-color: #6aaa64` (Wordle green), `color: #ffffff`, `border: none`, `border-radius: 4px`, `font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif`, `font-size: 14px`, `font-weight: 600`, `cursor: pointer`, `text-align: center`, `margin-top: 4px`
- `.onboarding-dismiss-btn:hover` — `background-color: #538d4e`
- `.onboarding-dismiss-btn:focus` — `outline: 2px solid var(--wb-text-secondary)`, `outline-offset: 2px`

Follow the existing string concatenation pattern using `'...\n' +` syntax. Use a `/* Onboarding overlay */` comment to introduce the block.

Do NOT create a new stylesheet file. Do NOT add any inline styles in content.js for onboarding elements.
  </action>
  <verify>
Open panelUI.js and confirm:
1. The onboarding CSS rules appear inside the `createStyles()` function's `css` string
2. The rules use `var(--wb-text)`, `var(--wb-border)`, `var(--wb-text-secondary)` — not hardcoded color values (except #6aaa64 for button and #ffffff for button text)
3. No new `CSSStyleSheet` object or `<style>` element is created
4. The `sheet.replaceSync(css)` call still appears after the new rules
  </verify>
  <done>Onboarding CSS classes exist in the existing constructable stylesheet; no new stylesheet files or style elements created.</done>
</task>

<task type="auto">
  <name>Task 2: Add onboarding lifecycle to content.js — flag, render, dismiss, guard, and backgroundInit integration</name>
  <files>src/content.js</files>
  <action>
This task adds the complete onboarding lifecycle to content.js. Five changes in one file:

**Change 1: Add isOnboardingActive flag (module level)**

Add `var isOnboardingActive = false;` at module level, next to the existing `var isComputing = false;` declaration (around line 41).

**Change 2: Add escapeKeyHandler function (module level)**

Add a named function at module scope (near the other utility functions):

```javascript
function escapeKeyHandler(event) {
  if (event.key === 'Escape') {
    dismissOnboarding();
  }
}
```

**Change 3: Add renderOnboarding() function**

Add a function that builds the onboarding overlay using `document.createElement()` calls (never innerHTML for content). The function:

1. Gets panel body via `window.WordleBot.panelUI.getBody()`
2. Clears body (`body.innerHTML = ''`) and sets `body.style.opacity = '1'`
3. Creates overlay div with class `onboarding-overlay`
4. Creates title div with class `onboarding-title`, text: `"Welcome to WordleBot!"`
5. Creates ordered list (`ol`) with class `onboarding-tips`
6. Creates three tip list items (`li`) with class `onboarding-tip`, each containing:
   - A span with class `onboarding-tip-number` containing `"1."`, `"2."`, `"3."` respectively
   - Text content for each tip:
     - Tip 1: `"WordleBot looks at your Wordle board and suggests the best next guess — ranked by how much each word narrows down the answer."`
     - Tip 2: `"Tap any suggestion to see why it's recommended. Tap again for more detail. Tap once more to collapse it."`
     - Tip 3: `"If WordleBot ever seems out of sync, Shift+click the refresh button in the top right to reset everything."`
7. Creates button with class `onboarding-dismiss-btn`, type `"button"`, text `"Got it"`, click listener calling `dismissOnboarding`
8. Appends all elements to overlay, appends overlay to body
9. Adds `document.addEventListener('keydown', escapeKeyHandler)`

**Change 4: Add dismissOnboarding() function**

Implements the locked decision: write storage BEFORE DOM removal using `.then()` pattern.

```javascript
function dismissOnboarding() {
  chrome.storage.local.set({ wordlebot_onboarded: true }).then(function() {
    isOnboardingActive = false;
    var body = window.WordleBot.panelUI.getBody();
    if (body) { body.innerHTML = ''; }
    if (window.WordleBot.lastSuggestions) {
      window.WordleBot.panelRenderer.render(window.WordleBot.lastSuggestions, true);
      if (window.WordleBot.dictionaryResult) {
        showSourceIndicator(window.WordleBot.dictionaryResult);
      }
    } else {
      var currentState = window.WordleBot.readBoardState();
      if (currentState && !isComputing) {
        processBoardState(currentState, true);
      }
    }
    document.removeEventListener('keydown', escapeKeyHandler);
  }).catch(function(err) {
    console.warn('[WordleBot] Failed to persist onboarding dismissal: ' + err.message);
    isOnboardingActive = false;
    var body = window.WordleBot.panelUI.getBody();
    if (body) { body.innerHTML = ''; }
    if (window.WordleBot.lastSuggestions) {
      window.WordleBot.panelRenderer.render(window.WordleBot.lastSuggestions, true);
    }
    document.removeEventListener('keydown', escapeKeyHandler);
  });
}
```

Key details:
- Storage write resolves BEFORE DOM removal (locked decision)
- On catch: still dismiss UI (don't trap user), but log warning
- Remove escape listener in both success and error paths
- Fall back to `processBoardState()` if `lastSuggestions` is null (edge case: very fast dismiss)

**Change 5: Add isOnboardingActive guard in processBoardState()**

Find the existing render call in `processBoardState()` where `panelRenderer.render()` and `showSourceIndicator()` are called. Wrap BOTH calls in an `if (!isOnboardingActive)` check:

```javascript
window.WordleBot.lastSuggestions = suggestions;
if (!isOnboardingActive) {
  window.WordleBot.panelRenderer.render(suggestions, isInitial);
  if (window.WordleBot.dictionaryResult) {
    showSourceIndicator(window.WordleBot.dictionaryResult);
  }
}
```

The `lastSuggestions` assignment MUST remain outside the guard — suggestions are always computed and stored, just not rendered while onboarding is active.

**Change 6: Integrate into backgroundInit()**

In the `backgroundInit()` function, AFTER `loadDictionaryAndCaches(false)` resolves and BEFORE the initial `processBoardState()` call:

1. Add the onboarding guard activation:
```javascript
if (window.WordleBot.isFirstInstall === true) {
  isOnboardingActive = true;
}
```

2. AFTER the initial `processBoardState()` call (which now computes but doesn't render due to the guard), add:
```javascript
if (window.WordleBot.isFirstInstall === true) {
  renderOnboarding();
}
```

3. This must come BEFORE `startObserver()` is called.

The sequence in backgroundInit is: load dictionary → set guard if first install → initial processBoardState (computes lastSuggestions, render blocked by guard) → renderOnboarding (shows overlay) → startObserver.

CRITICAL: Check `=== true` (not truthy). `null` must NOT trigger onboarding.

Do NOT export renderOnboarding or dismissOnboarding to `window.WordleBot` namespace — they are internal to content.js.
  </action>
  <verify>
1. Search content.js for `isOnboardingActive` — should appear: declaration, guard in processBoardState, set to true in backgroundInit, set to false in dismissOnboarding (twice: success + catch)
2. Search content.js for `escapeKeyHandler` — should appear: function declaration, addEventListener in renderOnboarding, removeEventListener in dismissOnboarding (twice: success + catch)
3. Search content.js for `isFirstInstall === true` — should appear twice in backgroundInit (guard activation + renderOnboarding call), never as truthy check
4. Search content.js for `wordlebot_onboarded` — should appear in dismissOnboarding's storage.local.set call
5. Verify `lastSuggestions` assignment is OUTSIDE the `!isOnboardingActive` guard in processBoardState
6. Verify dismissOnboarding uses `.then()` pattern (storage write resolves before DOM removal)
7. Load extension on NYT Wordle page with fresh profile (no storage) — onboarding overlay should appear
8. Click "Got it" — overlay disappears, suggestions appear immediately
9. Reload page — onboarding does NOT appear
  </verify>
  <done>
Complete onboarding lifecycle in content.js: isOnboardingActive flag guards processBoardState render; renderOnboarding() builds overlay with welcome header, three tips, and "Got it" button; dismissOnboarding() persists to storage then removes overlay and renders suggestions; Escape key dismisses via named handler; backgroundInit integrates the full flow gated on isFirstInstall === true.
  </done>
</task>

</tasks>

<verification>
1. Fresh install scenario: Clear all WordleBot storage, reload NYT Wordle — onboarding overlay appears with welcome header, three numbered tips, and green "Got it" button
2. "Got it" dismiss: Click button — overlay disappears instantly, suggestions appear with no loading state
3. Escape dismiss: Press Escape — same behavior as "Got it"
4. Persistence: After dismissing, reload page — onboarding does NOT reappear
5. Browser restart: Close and reopen browser, navigate to Wordle — onboarding does NOT reappear
6. Board interaction during onboarding: Type a letter while overlay is visible — overlay survives, is not replaced by suggestions
7. Existing user: User with prior WordleBot data — onboarding never appears (isFirstInstall === false)
8. Style consistency: Overlay uses same fonts, colors, and feel as the suggestions panel (dark mode and light mode)
9. No new files: Only src/content.js and src/panelUI.js are modified
10. No new permissions: manifest.json unchanged
</verification>

<success_criteria>
- Onboarding overlay appears for first-time users and covers three topics (ONBD-03, ONBD-04)
- "Got it" button and Escape key both dismiss the overlay permanently (ONBD-05)
- Dismissal persists across reloads and browser restarts via chrome.storage.local (ONBD-06)
- Everything renders inside the existing Shadow DOM panel (ONBD-07)
- processBoardState guard prevents overlay destruction during board updates
- Suggestions are pre-computed and appear instantly on dismiss
</success_criteria>

<output>
After completion, create `.planning/phases/17-onboarding-ui-and-integration/17-01-SUMMARY.md`
</output>
